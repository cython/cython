UNSET CFLAGS
PYTHON setup.py build_ext --inplace
PYTHON -c "import runner"

######## setup.py ########

import sys

if sys.version_info < (3, 12):
    print("Can't have opaque objects before 3.12")
    exit(0)

from Cython.Build.Dependencies import cythonize
from Cython.Compiler.Errors import CompileError
from distutils.core import setup

# ordered
setup(ext_modules= cythonize("[a-z]*.pyx"))

with open("rename_me_check_size_sizeof_obj_too_big.pxd", "r") as f:
    contents = f.read()
with open("check_size_sizeof_obj_too_big.pxd", "w") as f:
    f.write(contents)

setup(ext_modules= cythonize("_*.pyx"))

######## nonheaptype.pxd ###########

cdef class C:
    cdef int i

######## nonheaptype.pyx ###########
# distutils: define_macros=CYTHON_OPAQUE_OBJECTS=0 CYTHON_USE_TYPE_SPECS=0

cdef class C:
    pass

####### uses_nonheaptype.pyx ############
# distutils: define_macros=CYTHON_OPAQUE_OBJECTS=1 CYTHON_USE_TYPE_SPECS=1

from nonheaptype cimport C

####### check_size_boring.pxd ############

cdef class C:
    cdef int x

cdef class D:
    cdef int x

####### check_size_boring.pyx ############
# distutils: define_macros=CYTHON_OPAQUE_OBJECTS=1 CYTHON_USE_TYPE_SPECS=1

cdef class C:
    pass

cdef class D:
    pass

####### use_check_size_boring.pyx ########
# distutils: define_macros=CYTHON_OPAQUE_OBJECTS=1 CYTHON_USE_TYPE_SPECS=1

from check_size_boring cimport C, D

# subclassing triggers extra checks
cdef class E(D):
    cdef int y

####### rename_me_check_size_sizeof_obj_too_big.pxd #############

# This version is seen by _uses_check_size_sizeof_obj_too_big
cdef class CCC:
    cdef long big_array[10000]

####### check_size_sizeof_obj_too_big.pyx #############
# distutils: define_macros=CYTHON_OPAQUE_OBJECTS=1 CYTHON_USE_TYPE_SPECS=1

cdef class CCC:
    pass

####### _uses_check_size_sizeof_obj_too_big.pyx #########
# distutils: define_macros=CYTHON_OPAQUE_OBJECTS=1 CYTHON_USE_TYPE_SPECS=1

cimport check_size_sizeof_obj_too_big

####### runner.py ###############

import sys
if sys.version_info < (3, 12):
    print("Skipping...")
    exit(0)

import warnings

try:
    import uses_nonheaptype
except TypeError as e:
    assert "not a heap type" in e.args[0], e.args
else:
    assert False, "Should throw"

with warnings.catch_warnings(record=True) as w:
    warnings.simplefilter("always")
    import check_size_boring
    assert len(w) == 0  # no warnings expected - the file is correct

try:
    import _uses_check_size_sizeof_obj_too_big
except ValueError as e:
    assert "may indicate binary incompatibility" in e.args[0], e.args
else:
    assert False, "Should throw"

# The inverse case where sizeof(obj) is too big isn't currently
# detected with opaque types. However this is a limitation rather
# than a feature so it isn't explicitly tested.
