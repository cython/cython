# -*- coding: utf-8 -*-
# tag: py3, pep489

PYTHON setup.py build_ext --inplace
PYTHON -m mydoctest

########### mydoctest.py #######

import sys
if sys.version_info[0] < 3:
    exit() # I'm struggling to restrict srctree tests to a single Python version
    
import doctest
import from_py
val = doctest.testmod(from_py)[0]
import from_cy
val += doctest.testmod(from_cy)[0]

exit(val)

########### setup.py ########

# -*- coding: utf-8 -*-

from __future__ import unicode_literals

import sys
from Cython.Build import cythonize

files = ["mymoδ.pyx", "from_cy.pyx"]


# on Python 2 just run pyx->c; don't compile the C file
modules = cythonize(files)

if sys.version_info[0] >= 3:
    from distutils.core import setup

    setup(
        ext_modules = modules
    )

############ mymoδ.pyx #########

def f():
    return True
    
############ pxd_moδ.pxd ##########

cdef struct S:
    int x
    
############ from_py.py #########

# -*- coding: utf-8 -*-

import mymoδ
from mymoδ import f

__doc__ = """
>>> mymoδ.f()
True
>>> f()
True
"""

######### from_cy.pyx ##########

# -*- coding: utf-8 -*-

import mymoδ

from mymoδ import f

cimport pxd_moδ
from pxd_moδ cimport S


def test_imported():
    """
    >>> test_imported()
    True
    """
    return mymoδ.f() and f() # True and True

def test_cimported():
    """
    >>> test_cimported()
    3
    """
    cdef pxd_moδ.S v1
    v1.x = 1
    cdef S v2
    v2.x = 2
    return v1.x + v2.x
    
