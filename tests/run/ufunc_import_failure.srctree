PYTHON setup.py build_ext --inplace
PYTHON test_bad_ufunc_type.py

######## setup.py ###########
from setuptools import Extension, setup
from Cython.Build import cythonize

try:
    import numpy as np
except ImportError:
    # We can't use tags in srctree tests, so just make it "work" without numpy
    exit()


setup(ext_modules=cythonize([
    Extension(
        "bad_ufunc_type", ["bad_ufunc_type.pyx"],
        include_dirs=[np.get_include()]
    )]))

######## bad_ufunc_type.pyx ###########

cdef extern from *:
    """
    typedef char someone_elses_double;
    """
    # Note that this is wrong... char is not the same size as a usable
    # floating point type.
    ctypedef double someone_elses_double
    
cimport cython

@cython.ufunc
cdef double use_our_float_type(someone_elses_double x):
    return x


######## test_bad_ufunc_type.py ###########

try:
    import numpy
except ImportError:
    print("Skipping 'ufunc_import_failure' due to missing numpy")
    exit()

try:
    import bad_ufunc_type
except TypeError:
    pass  # good
else:
    print("TypeError not caught")
    exit(1)
